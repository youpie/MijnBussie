name: MijnBussie
services:
  mijn-bussie:
    image: docker.io/library/mijn_bussie
    user: root
    volumes:
      - .env:/app/.env:z
      - ${SAVE_TARGET}:/app/calendar/:z
      - ./data/:/app/data/:z
    environment:
      - RUST_LOG=${BUSSIE_LOG}
    ports:
      - ${INSTANCE_API_PORT}:3000
    restart: unless-stopped
    networks:
      - MijnBussie
    depends_on:
      - db
      - selenium-hub
      - node-docker
    profiles: ["prod", "instance"]

  mijn-bussie-auth: 
    image: docker.io/library/mijn_bussie_auth
    user: root
    volumes:
      - .env:/app/.env:Z
    environment:
      - RUST_LOG=${AUTH_LOG}
    ports:
      - ${API_PORT}:${API_PORT}
    restart: unless-stopped
    networks:
      - MijnBussie
    depends_on:
      #- mijn-bussie
      - db
      - selenium-hub
      - node-docker
    profiles: ["prod", "auth"]

  db:
    image: postgres
    restart: unless-stopped
    user: root
    # set shared memory limit when using docker compose
    shm_size: 128mb
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_USER: ${POSTGRES_USERNAME}
    ports:
      # WARNING: Exposes database
      - 5432:5432
    networks:
      - MijnBussie
    volumes:
      - ./pg_data:/var/lib/postgresql:Z

  selenium-hub:
    image: selenium/hub:4.40.0
    container_name: selenium-hub
    networks:
      - MijnBussie
    ports:
      - 4444:4444
    environment:
      - SE_NODE_MAX_SESSIONS=18
      - SE_NODE_DETECT_DRIVERS=false

  node-docker:
    image: selenium/node-docker:4.40.0
    user: root
    volumes:
      - ./assets:/opt/selenium/assets:z
      - ./config.toml:/opt/selenium/docker.toml:z
      - /var/run/docker.sock:/var/run/docker.sock:z
    environment:
      - SE_NODE_DOCKER_CONFIG_FILENAME=docker.toml
      - SE_EVENT_BUS_HOST=selenium-hub
    networks:
      - MijnBussie
    restart: unless-stopped

  node-docker-2:
    image: selenium/node-docker:4.40.0
    user: root
    volumes:
      - ./assets:/opt/selenium/assets:z
      - ./config.toml:/opt/selenium/docker.toml:z
      - /var/run/docker.sock:/var/run/docker.sock:z
    environment:
      - SE_NODE_DOCKER_CONFIG_FILENAME=docker.toml
      - SE_EVENT_BUS_HOST=selenium-hub
    networks:
      - MijnBussie
    restart: unless-stopped

  node-docker-3:
    image: selenium/node-docker:4.40.0
    user: root
    volumes:
      - ./assets:/opt/selenium/assets:z
      - ./config.toml:/opt/selenium/docker.toml:z
      - /var/run/docker.sock:/var/run/docker.sock:z
    environment:
      - SE_NODE_DOCKER_CONFIG_FILENAME=docker.toml
      - SE_EVENT_BUS_HOST=selenium-hub
    networks:
      - MijnBussie
    restart: unless-stopped

  node-docker-4:
    image: selenium/node-docker:4.40.0
    user: root
    volumes:
      - ./assets:/opt/selenium/assets:z
      - ./config.toml:/opt/selenium/docker.toml:z
      - /var/run/docker.sock:/var/run/docker.sock:z
    environment:
      - SE_NODE_DOCKER_CONFIG_FILENAME=docker.toml
      - SE_EVENT_BUS_HOST=selenium-hub
    networks:
      - MijnBussie
    restart: unless-stopped

networks:
  MijnBussie:
    ipam:
      config:
        - subnet: 10.19.0.0/16